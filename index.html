<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What do you Swift?</title>
    <link rel="icon" href="/WhatDoYouSwift.jpg" type="image/jpg" />
    <script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .screen {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: none;
        }

        .screen.active {
            display: block;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .divider {
            margin: 20px 0;
            color: #999;
            position: relative;
            text-align: center;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #e0e0e0;
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .game-code {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }

        .game-code-value {
            font-weight: bold;
            font-size: 1.8rem;
            color: #667eea;
            letter-spacing: 3px;
            display: block;
            margin: 10px 0;
            user-select: all;
            word-break: break-all;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .players-list {
            margin: 20px 0;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .ready-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .ready-badge.ready {
            background: #d4edda;
            color: #155724;
        }

        .ready-badge.not-ready {
            background: #f8d7da;
            color: #721c24;
        }

        .game-header {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .round-info {
            font-weight: bold;
            font-size: 1.2rem;
            color: #667eea;
        }

        .scores {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .score-item {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .image-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .image-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .card {
            background: white;
            border: 4px solid #000;
            border-radius: 20px;
            padding: 30px 20px;
            min-height: 180px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            line-height: 1.4;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }

        .card:hover:not(:disabled) {
            transform: translateY(-10px) rotate(-2deg);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border-color: #667eea;
        }

        .card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.5);
        }

        .card:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .judge-card-selection {
            background: #fff9e6;
            border: 3px solid #ffc107;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }

        .judge-card-selection h3 {
            color: #856404;
            margin-bottom: 20px;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .image-card {
            cursor: pointer;
            border: 4px solid #e0e0e0;
            border-radius: 15px;
            padding: 10px;
            transition: all 0.3s;
            background: white;
        }

        .image-card:hover {
            border-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .image-card img {
            width: 100%;
            border-radius: 10px;
        }

        .winner-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }

        .winner-card h3 {
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .status-message {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            color: #0c5460;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .error-message {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .cards-grid { grid-template-columns: 1fr; }
            .game-header { flex-direction: column; }
            .game-code-value { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HOME SCREEN -->
        <div id="home-screen" class="screen active">
            <h1>üé≠ MEME GAME üé≠</h1>
            <p class="subtitle">Multiplayer P2P - Gioca senza server!</p>

            <div id="error-container"></div>

            <div class="input-group">
                <label>Il tuo nome</label>
                <input type="text" id="player-name" placeholder="Inserisci il tuo nome" maxlength="20">
            </div>

            <button class="btn btn-primary" onclick="createGame()">
                üéÆ Crea Partita
            </button>

            <div class="divider">oppure</div>

            <div class="input-group">
                <label>Codice Partita</label>
                <input type="text" id="game-code-input" placeholder="Inserisci il codice">
            </div>

            <button class="btn btn-secondary" onclick="joinGame()">
                üë• Unisciti a Partita
            </button>

            <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 10px; font-size: 0.9rem;">
                <strong>‚ÑπÔ∏è Come funziona:</strong><br>
                ‚Ä¢ Connessione peer-to-peer (nessun server)<br>
                ‚Ä¢ Funziona su GitHub Pages<br>
                ‚Ä¢ Condividi il codice con gli amici<br>
                ‚Ä¢ Minimo 3 giocatori per iniziare
            </div>
        </div>

        <!-- LOBBY SCREEN -->
        <div id="lobby-screen" class="screen">
            <h2>üéÆ Lobby</h2>
            
            <div class="game-code">
                <div>Condividi questo codice con i tuoi amici:</div>
                <span class="game-code-value" id="room-code"></span>
                <button class="copy-btn" onclick="copyRoomCode()">üìã Copia Codice</button>
            </div>

            <div id="status-container"></div>

            <div class="players-list">
                <h3>Giocatori (<span id="player-count">0</span>/8)</h3>
                <div id="players-container"></div>
            </div>

            <button class="btn btn-secondary" onclick="toggleReady()">
                ‚úì Sono Pronto!
            </button>

            <button id="start-game-btn" class="btn btn-success" onclick="startGame()" style="display: none;">
                üöÄ Avvia Partita
            </button>

            <button class="btn" onclick="leaveLobby()" style="background: #dc3545; color: white;">
                ‚Üê Torna alla Home
            </button>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="screen">
            <div class="game-header">
                <div class="round-info">
                    Round <span id="round-num">1</span> | Giudice: <span id="judge-name"></span>
                </div>
                <div class="scores" id="scores-container"></div>
            </div>

            <div class="image-container" id="image-container-game" style="display: none;">
                <img id="current-meme" src="" alt="Meme">
            </div>

            <div id="game-content"></div>
        </div>
    </div>

    <script>
        const MEME_IMAGES = [
            { url: 'https://i.imgflip.com/30b1gx.jpg', alt: 'Drake Hotline Bling' },
            { url: 'https://i.imgflip.com/1bij.jpg', alt: 'Distracted Boyfriend' },
            { url: 'https://i.imgflip.com/4t0m5.jpg', alt: 'Bernie Sanders' },
            { url: 'https://i.imgflip.com/1ur9b0.jpg', alt: 'Surprised Pikachu' },
            { url: 'https://i.imgflip.com/26am.jpg', alt: 'One Does Not Simply' },
            { url: 'https://i.imgflip.com/1bhk.jpg', alt: 'Success Kid' },
            { url: 'https://i.imgflip.com/9ehk.jpg', alt: 'Third World Success' },
            { url: 'https://i.imgflip.com/1g8my4.jpg', alt: 'Expanding Brain' }
        ];

        const TEXT_CARDS = [
            "Quando il tuo profilo social √© attivo ma tu sei spento dentro", "Quando ti chiedono come stai e tu rispondi con un meme",
            "Quando ongi \"tutto benen\" √© un grido silenzioso d'aiuto", "Quando parli con il tuo io del passato e vi mettete a ridere insieme",
            "Quando finisci i meme salvati e devi affrontare la realt√†", "Quando qualcuno ti dice \"non devi preoccuparti\" e peggiora tutto",
            "Quando non sei triste ma neanche proprio allegro", "Quando ti dicono \"dai sorridi\" e tu stai gai dando il massimo",
            "Quando ti fai una domanda seria e finisci su Tik Tok per distrarti", "Quando una frase ti colpisce nel cuoer e tu pensi \"wow, ferito gratis anche oggi\" ",
            "Quando la batteria del tuo telefono muore e con lei anche la tua volont√† di vivere", "Quando l'unica cosa che va veloce nella tua vita √® la connessione a internet",
            "Quando cerchi di essere maturio ma poi parte il panico", "Quando hai mille pensieri ma nessuna voglia di affrontarne anhe solo uno",
            "Quando ti guardi allo specchio e pensi: \"e con te dovrei conquistare il mondo?\"", "Quando ogni messaggio vocael √® una seduta di terapia gratuita",
            "Quando ti dicono \"non pwnsarci\" e tupensi a quello per le prossime 4 ore", "Quando la tua risposta automatica √®:\"√® un periodo \"",
            "Quando tutti crescono e tu cerchi ancora la voglia di alzarti dal letto", "Quando hai bisogno di una vacanza da te stesso",
            "Quando ogni luned√¨ ti sembra una punizione divina", "Quando entri in loop su qualcosa che non centra nulla",
            "Quando devi prendere una decisione e chiedi consiglio... a un meme", "Quando tutto va storto ma tu hai ancora speranze(√® questo il vero problema)",
            "Quando ti senti osservato ma in realt√† nessuno se ne accorge mai", "Quando l'unica costanza nella vita √® l'autosabotaggio",
            "Quando vuoi fare qualcosa di produttivo ma ti scappa la voglia", "Quando apri il portafoglio e lui ti guarda come per dire \"io ho fatto il possibile\"",
            "Quando hai dormito 10 ore ma ti sveglicomunque stanco dalla vita", "Quando dici \"oggi rispondo a tutti i messaggi\" e sparisci dinuovo",
            "Quando prometti a te di essere pi√π zen ma la gente continua a respirare","Quando l'unica cosa stabile nella tua vita √® la connessione Wi-Fi",
            "Quando decidi di essere produttivo e ti serve una pausa dopo aver fatto la lista","Quando ogni giorno sembra un sequel non richiesto del precedente",
            "Io che reagisco auna red flag come farebbe una fan di Taylor Swift: piangendo e romanticizzando tutto","Quando capisci che questa realzione finir√† mala ma sei una fan di Taylor Swift, quindi resti per il materiale emotivo",
            "Io che dico 'non mi tocca' mentre penso a quale canzone di Taylor Swift descrive esattamente questo trauma","Essere una fan di Taylor Swift significa chiamare 'crescita personale' il sofffrire con una colonna sonora",
            "Io che entro in una relazione sapendo gi√† quale album di Taylor Swift mi distrugger√† dopo","Quando vai a dormire presto e ti svegli stanco lo stesso",
            "Quando entri in classe e il prof ha quell' energia che tu hai perso nel 2016","Quando ti viene fame subito dopo aver mangiato",
            "Quando sorridi solo prerch√® non puoi permetterti un esaurimento nervoso in quesl moemnto","Quando ricevi un messaggio e pansi \"oddio, ora devo rispondere...\" ",
            "Quando i tuoi amici hanno tutti un vita e tu sei qui a leggere i meme","Quando \"vediamoci presto\" resta solo un  miraggio per mesi",
            "Quando la tua motivazione dipende dal meteo e dal segno zodiacale","Quando sei uscito per distrarti e hai trovato solo altri motivi per pensare troppo",
            "Quando ti viene chiesto \"sei felice?\" e ti fermi a fare un bilanoio di guerra","Qunando l'unico goal raggiunto della gioranata √® non urlare in pubblico",
            "Quando vai a dormire presto e comunque sogni di essere in ritardo","QUndo vedi gente della tua et√† realizzata e tu sei ancora al tutorial",
            "Quando l'autosabotaggio √® ormai una competenza nel curriculum","Quando l'unico piano per il weekend √® spopravvivere emotivamente",
            "Quando il tuo sarcasmo √® l'unica difesa contro la realt√†","quando ti dicono \"sei troppo sensibile\" e tu piangi con dignit√†",
            "Quando inizi una serie e finisci la stagione prima di finire un compito","Quando sei l'amico \"divertente\" ma dentro hai un monologo dramatico",
            "Quando il piano era \"iniziare bene la giornata\" e dopo 10 minuti stai gia urlando","Quando ti lamenti di nona vere tempo ma hai rivisto 7 volte la stessa serie",
            "Quando vuoi stare da solo ma anche sentirti cercato, ma anche ignorato, ma anceh amato","Quando fai finta di essere d'accordo solo per evitare discussioni",
            "Quando vorresti solo dormire ma l'ansia ha prenotato la suite","Quando ogni messaggio √® un test di interpretazione",
            "Quando fai una figuraccia e pensi \"ci passer√≤ ogni notte per i prossimi 1 anni\"","Quando realizzi che non sai nemmenno cosa ti piace davvero",
            "Quando ridi per non piangere ma un po' piangi comunque","quando il tuo modo di affrontare i problemi √® ignorarli fino a quando non diventano mostri",
            "Quando il Wi-Fi va lento e tu riconosideri la tua intera esistenza","Quando ti guardi allo specchio e parte la crisi d'identit√†",
            "Quando rispondi \"non lo so\" ma dentro di ahi un saggio di 32 pagine","Quando dici \"ora studio ma ti ritrovi a cambiare la suoneria\"",
            "Quando piangi e ti scatti selfi per vedere quanto sei melodrammatico","Quando ti raccontano un segreto e tu ti senti il contenitor esacro della verit√†",
            "Quando fingi di essere chill ma hai gi√† scritto 2 lettere di addio","Quando dici \" mi faccio i fatti miei\" ma poi diventi Sherlock Holmes",
            "Quando il tuo amico √® in ritardo ma tu lo hai cancellato dalla tua vita","Quando dici\"basta social per oggi\" e dopo 2 minuti sei su Tik Tok",
            "Quando ti regalano qualcosa di brutto e devi sorridere forte","Quando dici \"oggi sar√≤ produttivo\" e ti ritrovi a guardaer video di gente che pulisce tappeti",
            "Quando apri il libro per studiare e ti scappa la viglia di vivere","Quando il tuo cane ha una vita suciale pui attiva della tua",
            "Quando pensi \"√® solo un esame\" ma il tuo futuro comincia a tremare","Quando metti la sveglia alle 7 ma la spegni fino alle 11",
            "Quando ti svegli e ti ricordi che oggi devi essere adulto","Quando vai al supermencato con la lista ma torni solo con snack",
            "Quando provia a mangiare sano ama poi tua nonna cuciina","Quando sei in mezzo a una crisi esistenziale ma sorridi per non insospettire nessuno",
            "Quando ti ricordii qualcosa di imbarazzante che hai fatto 8 anni fa ","Quando hai cos√¨ tanto da fare che decidi di non fare niente",
            "Quando \"prendo una pausa di 5 minuti\" e il sole √® gi√† tramontato","Quando il prof inizia a spigare e tu sei gi√† al terzo rewatch mentale della tua serie preferita",
            "Quando cerchi di essere forte ma la Wi-FI non funziona","Quando ti dicono \"stai tranquillo\" e ora sei ufficialmente nel panico",
            "Quando qualcuno ti chiama e tu pensi: potevi scrivermi","Quando potevi dormire e il tuo cervello inizia il podcast delle paranoie",
            "Quando sei l'unico del grupppo ch enon ha capito il piano","Quando dici \"basta shopping online\" e Amazon ti scrive per sapere se stai bene",
            "Quando sei cos√¨ stanco che ti addormenti mentre stai procrastinando","Quando vedi un meme troppo vero e ti senti violato ",
            "Quando provi a fare il figo e la vita ti umilia subito","Quando parli in sogno e riveli cose che nemmeno sapevi",
            "Quando il karma funziona ma non nel tuo favore","Quando ti dicono\"√® solo un gioco\" ma tu hai gi√† pianificato la vendetta",
            "Quando dici \"non mi intressa\" e ppoi ti fei 3 profili fake","",
            "Quando ti alzi dal letto e gia vuoi tornarci","Quando il tuo amico √® felice e tu cerchi di esserlo per lui, anche se sei a pezzi",
            "Quando fai una brutta figura e pensi di trasferirti all'estero","Quando il tuo gatto ti giudica e tu inizi adubitare di te stesso",
            "Quando ti svegli all'improvviso e non sai pi√π in che anno sei","Quando cerchi di motivsrti ma ti disttrai con un granello di polvere",
            "Quando dici non importe a ma invece importa eccome","Quando vuoi solo un consiglio e ti dicono \"te lo avevo detto\"",
            "Quando ti innamori del barista e vai aprendere 14 caff√® al giorno","Quando vuoi solo dormire ma la tua coscienza vuole solo parlare",
            "Quando dici\"vado a studiare\" ma finisci a riordinare i cavi del caricatore","Quando ti metti le cuffie ma niente parte, colo silenzio e tristezza",
            "Quando fai finta di capire il film ma se confuso dal minuto uno","Quando usi parole difficili solo per sembrare interessante",
            "Quando ti dimenti il nome di qualcuno e speri che non se nw accorga","Qualcuno ti dice \"sii te stesso\" e tu pensi \"forse no\"",
            "Qunado cerchi l'amore amtrovi solo notifiche spam","Quando dici \"sto bene da solo\" ma intanto coccolo un peluche",
            "Qunado prendi una decisione e la rimpiangi in 0.3 secondi","Quando fai una battuta e nessuno ride",
            "Quando sei sarcastico e ti prendono sul serio","Quando vuoi essere produttivo ma ti blocca la vita",
            "Quando ti dicono\"vedrai andr√† meglio\" e peggiora","Quando dicono che suamo pigre ma sappiamo fare il binge-watching come un lavoro a tempo pieno",
            "La tua reazione quando qualcuno ti chiede :'che fai dopo il diploma?'","Quando entri in classe e ti ricordi che c'era il compito oggi",
            "Quando dici che odi il caff√® ma sei alla terza tazza","Io che entro in un negozio giusto per 'guaradre' e ne esco con 5 borse",
            "La tua faccia quando apri il gruppo WWhatsApp e vedi 147 notifiche nel gruppo","Quando copi tutto il compito e alla fine lui prende 6 e tu 3",
            "Io che apro il libro per studiare e il cervello va subito un stand-by","Quando il prof ti chiede di leggere ad alta voce e i cervello dimentica come si legge",
            "La tua faccia quando il prof dice: 'Questo argomento √® facilissimo' e poi parla in aramaico antico","Io e le mie amiche che ci guardiamo in silenzio perch√® sappiamo gi√† cosa sta pensando l'altra",
            "Quando organizziamo tutto per uscire e poi restiamo a casa ina pigiama","La tua amica dice :'Non compro niente, oggi risparmio' e 10 minuti dopo ha svuotato il negozio",
            "Quando siamo tutte d'accordo che lui √® un cretino ma comunque stolkeriamo il suo profilo insieme","io e le mie amiche che fingiamo di essere mature davanti aglia ltri ma siamo un meme vivente tra di noi",
            "Quando lui manda un cuore e tu : Questo √® amore vero","io che cerco di smettere di sembare tranquilla quando in realt√† sto monitorando ogni sua mossa",
            "Quando lui ti dice 'Buongiorno' e tu hai gia immaginata il matrimonio","la tua faccia quando vede il suo nome comparire nelle notifiche",
            "Quando lui ti risponde dopo ore e tu fai finta di non aver aspettato tutto il giorno","Quando dici che non sei sopra la situazione ma hai gi√† scritto un messaggio di 3000 parole",
            "Io che provo a stare fuori dal dramma ma finisco a raccontarlo in ogni dettaglio alle amiche","Quando scopri che anno fatto un'uscita senza di te e sorridi ma dentro muori",
            "Io che dico: 'Non mi interessa pi√π' e 5 minuti dopo sto gia analizzando la situazione con le amiche","Quando il concerto non √® ancora finito, ma tu hai gi√† il cuore spezzato perch√® non sai quando sar√† la prossima volta",
            "Quando Taylor canta Shake It Off e tu realizzi che sei l'unica persona nel tuo gruppo che non sa ballare","Qunado pendi di essere pronto per il concerto, ma poi Taylor inizia a cantare Fearless e ti trasformi in una persona che non smette pi√π di piangere",
            "Io e la mia amica che ci capiamo con uno sguardo durante un disastro sociale","Quando lei diche che odia qualcunoe io sono gi√† pronta con la lista dei motivi per odiarlo anch'io",
            "Io e le mie amiche dopo ave deciso di non prendere il dolce... e prendiamo 3 torte","La tua faccia quando lui ti chiama per nome e non con il soprannome che gli hai inventato nella tua testa",
            "Quando ti mandano un messaggio dopo 3 ore e risponde solo con 'ok'","La tua amica che ti urla: 'Bloccalo subito!' e tu: Ma aspetta,forse mi ama!",
            "Quando il dramma si calma e ti accorgi che la sua vita √® diventata noiosa","Quando dici 'Esco per 5 minuti' e torni 3 ore dopo con borse piene",
            "Io che dico che sono a dieta e poi: 'Ma una pizza non conta , vero?'","Quando dici \"vediamo come va\" e poi va male",
            "Quando ti innamori dopo 3 messaggi","Quando cerchi di essere misterioso ma sei solo curioso",
            "Quando senti una canzone triste e la metti in loop per soffrire meglio","Quando parli con te stesso e perdi comunque la discussione",
            "Quando l'oroscopo ti dice di avere pazienza ma sei gi√† esploso","Qundo il tuo amico dice \"fidati di me\" e tu prepari gia il disastro",
            "Quando cerchi di sembraer maturo ma ti emozioni per le caramelle","Quando sei l'unico single al tavolo e sorridi per non piangere",
            /*"","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",
            "","",*/
        ];

        let peer = null;
        let myPeerId = null;
        let connections = {};
        let isHost = false;
        let playerName = '';
        let hostConnection = null;
        
        let gameState = {
            players: [],
            currentRound: 0,
            judgeIndex: 0,
            currentImage: null,
            phase: 'lobby',
            submissions: [],
            myCards: [],
            selectedCard: null
        };

        function initPeer(callback) {
            console.log('Initializing PeerJS...');
            peer = new Peer({
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478' }
                    ]
                }
            });

            peer.on('open', (id) => {
                myPeerId = id;
                console.log('My peer ID:', id);
                if (callback) callback();
            });

            peer.on('connection', (conn) => {
                console.log('Incoming connection from:', conn.peer);
                handleConnection(conn);
            });

            peer.on('error', (err) => {
                console.error('Peer error:', err);
                showError('Errore di connessione: ' + err.type);
            });
        }

        function createGame() {
            playerName = document.getElementById('player-name').value.trim();
            if (!playerName) {
                showError('Inserisci il tuo nome!');
                return;
            }

            initPeer(() => {
                isHost = true;
                gameState.players = [{
                    id: myPeerId,
                    name: playerName,
                    score: 0,
                    ready: false,
                    isHost: true,
                    cards: []
                }];

                showScreen('lobby-screen');
                document.getElementById('room-code').textContent = myPeerId;
                updatePlayersUI();
                showStatus('In attesa di giocatori...');
            });
        }

        function joinGame() {
            playerName = document.getElementById('player-name').value.trim();
            const roomCode = document.getElementById('game-code-input').value.trim();

            if (!playerName || !roomCode) {
                showError('Inserisci nome e codice partita!');
                return;
            }

            initPeer(() => {
                isHost = false;
                showStatus('Connessione in corso...');
                
                const conn = peer.connect(roomCode);
                hostConnection = conn;
                handleConnection(conn);

                conn.on('open', () => {
                    console.log('Connected to host');
                    conn.send({
                        type: 'join',
                        player: { 
                            id: myPeerId, 
                            name: playerName, 
                            score: 0, 
                            ready: false,
                            cards: []
                        }
                    });
                    showScreen('lobby-screen');
                    document.getElementById('room-code').textContent = roomCode;
                });

                conn.on('error', (err) => {
                    console.error('Connection error:', err);
                    showError('Impossibile connettersi alla partita');
                });
            });
        }

        function handleConnection(conn) {
            connections[conn.peer] = conn;

            conn.on('data', (data) => {
                console.log('Received:', data.type, data);
                handleMessage(data, conn);
            });

            conn.on('close', () => {
                console.log('Connection closed:', conn.peer);
                delete connections[conn.peer];
                
                if (isHost) {
                    gameState.players = gameState.players.filter(p => p.id !== conn.peer);
                    broadcast({ type: 'players-update', players: gameState.players });
                    updatePlayersUI();
                }
            });

            conn.on('error', (err) => {
                console.error('Connection error:', err);
            });
        }

        function handleMessage(data, conn) {
            try {
                switch (data.type) {
                    case 'join':
                        if (isHost) {
                            console.log('Player joined:', data.player.name);
                            gameState.players.push(data.player);
                            
                            // Send full state to new player
                            conn.send({ type: 'players-update', players: gameState.players });
                            
                            // Notify all other players
                            broadcast({ type: 'players-update', players: gameState.players }, conn.peer);
                            
                            updatePlayersUI();
                        }
                        break;

                    case 'players-update':
                        console.log('Players update:', data.players);
                        gameState.players = data.players;
                        updatePlayersUI();
                        break;

                    case 'ready-toggle':
                        if (isHost) {
                            const player = gameState.players.find(p => p.id === data.playerId);
                            if (player) {
                                player.ready = !player.ready;
                                broadcast({ type: 'players-update', players: gameState.players });
                                updatePlayersUI();
                            }
                        }
                        break;

                    case 'start-game':
                        console.log('Game starting...');
                        startGameplay(data.gameData);
                        break;

                    case 'judge-select-image':
                        if (isHost) {
                            gameState.currentImage = data.image;
                            gameState.phase = 'submitting';
                            broadcast({ type: 'game-update', currentImage: data.image, phase: 'submitting' });
                            updateGameUI();
                        }
                        break;

                    case 'submit-card':
                        if (isHost) {
                            console.log('Card submitted:', data.submission);
                            gameState.submissions.push(data.submission);
                            
                            const nonJudgePlayers = gameState.players.length - 1;
                            if (gameState.submissions.length === nonJudgePlayers) {
                                startVotingPhase();
                            }
                        }
                        break;

                    case 'vote':
                        if (isHost) {
                            handleVote(data.cardIndex);
                        }
                        break;

                    case 'game-update':
                        console.log('Game update:', data);
                        updateGameState(data);
                        break;
                }
            } catch (err) {
                console.error('Error handling message:', err);
            }
        }

        function broadcast(data, excludePeer = null) {
            Object.keys(connections).forEach(peerId => {
                if (peerId !== excludePeer && connections[peerId].open) {
                    try {
                        connections[peerId].send(data);
                    } catch (err) {
                        console.error('Error sending to', peerId, err);
                    }
                }
            });
        }

        function updatePlayersUI() {
            const container = document.getElementById('players-container');
            if (!container) return;
            
            container.innerHTML = '';

            gameState.players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span>
                        ${player.name} 
                        ${player.isHost ? 'üëë' : ''}
                        ${player.id === myPeerId ? '(Tu)' : ''}
                    </span>
                    <span class="ready-badge ${player.ready ? 'ready' : 'not-ready'}">
                        ${player.ready ? '‚úì Pronto' : 'In attesa'}
                    </span>
                `;
                container.appendChild(div);
            });

            document.getElementById('player-count').textContent = gameState.players.length;

            if (isHost) {
                const allReady = gameState.players.every(p => p.ready) && gameState.players.length >= 3;
                const startBtn = document.getElementById('start-game-btn');
                if (startBtn) {
                    startBtn.style.display = allReady ? 'block' : 'none';
                }
            }
        }

        function toggleReady() {
            const me = gameState.players.find(p => p.id === myPeerId);
            if (!me) return;
            
            me.ready = !me.ready;
            
            if (isHost) {
                broadcast({ type: 'players-update', players: gameState.players });
            } else {
                if (hostConnection && hostConnection.open) {
                    hostConnection.send({ type: 'ready-toggle', playerId: myPeerId });
                }
            }
            updatePlayersUI();
        }

        function startGame() {
            if (!isHost) return;

            console.log('Starting game...');
            
            gameState.currentRound = 1;
            gameState.judgeIndex = Math.floor(Math.random() * gameState.players.length);
            gameState.phase = 'judge-selecting';
            gameState.submissions = [];
            gameState.currentImage = null;
            
            gameState.players.forEach(player => {
                player.cards = getRandomCards(7);
                player.score = 0;
            });

            const gameData = {
                players: gameState.players,
                currentRound: gameState.currentRound,
                judgeIndex: gameState.judgeIndex,
                currentImage: null,
                phase: gameState.phase
            };

            broadcast({ type: 'start-game', gameData });
            startGameplay(gameData);
        }

        function startGameplay(data) {
            console.log('Starting gameplay with data:', data);
            
            Object.assign(gameState, data);
            
            const me = gameState.players.find(p => p.id === myPeerId);
            if (me && me.cards) {
                gameState.myCards = me.cards;
            }

            showScreen('game-screen');
            updateGameUI();
        }

        function updateGameUI() {
            document.getElementById('round-num').textContent = gameState.currentRound;
            
            const judge = gameState.players[gameState.judgeIndex];
            if (judge) {
                document.getElementById('judge-name').textContent = judge.name;
            }
            
            const imageContainer = document.getElementById('image-container-game');
            if (gameState.currentImage) {
                document.getElementById('current-meme').src = gameState.currentImage.url;
                imageContainer.style.display = 'block';
            } else {
                imageContainer.style.display = 'none';
            }

            const scoresContainer = document.getElementById('scores-container');
            scoresContainer.innerHTML = gameState.players.map(p => 
                `<span class="score-item">${p.name}: ${p.score || 0}</span>`
            ).join('');

            const contentDiv = document.getElementById('game-content');
            const isJudge = gameState.players[gameState.judgeIndex].id === myPeerId;

            if (gameState.phase === 'judge-selecting') {
                if (isJudge) {
                    renderJudgeImageSelection();
                } else {
                    contentDiv.innerHTML = `<div class="status-message"><h3>‚è≥ Il giudice sta scegliendo l'immagine...</h3><p>Aspetta che ${judge.name} scelga il meme!</p></div>`;
                }
            } else if (gameState.phase === 'submitting') {
                if (isJudge) {
                    contentDiv.innerHTML = '<div class="status-message"><h3>üë®‚Äç‚öñÔ∏è Sei il giudice!</h3><p>Aspetta che gli altri giocatori inviino le carte...</p></div>';
                } else {
                    renderCardSelection();
                }
            } else if (gameState.phase === 'voting') {
                if (isJudge) {
                    renderVoting();
                } else {
                    contentDiv.innerHTML = '<div class="status-message"><h3>‚è≥ Votazione in corso</h3><p>Il giudice sta scegliendo la carta migliore...</p></div>';
                }
            } else if (gameState.phase === 'results') {
                renderResults();
            }
        }

        function renderJudgeImageSelection() {
            const html = `
                <div class="judge-card-selection">
                    <h3>üë®‚Äç‚öñÔ∏è Sei il giudice! Scegli l'immagine meme per questo round:</h3>
                    <div class="image-grid">
                        ${MEME_IMAGES.map((img, i) => `
                            <div class="image-card" onclick="selectJudgeImage(${i})">
                                <img src="${img.url}" alt="${img.alt}">
                                <p style="margin-top: 10px; font-size: 0.85rem; color: #666;">${img.alt}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('game-content').innerHTML = html;
        }

        function selectJudgeImage(index) {
            const selectedImage = MEME_IMAGES[index];
            gameState.currentImage = selectedImage;
            gameState.phase = 'submitting';

            if (isHost) {
                broadcast({ type: 'game-update', currentImage: selectedImage, phase: 'submitting' });
            } else {
                hostConnection.send({ type: 'judge-select-image', image: selectedImage });
            }

            updateGameUI();
        }

        function renderCardSelection() {
            const hasSubmitted = gameState.selectedCard !== null;
            const html = `
                <h3 style="text-align: center; margin: 20px 0;">
                    ${hasSubmitted ? '‚úì Carta inviata! Aspetta gli altri...' : 'Scegli la tua carta migliore:'}
                </h3>
                <div class="cards-grid">
                    ${gameState.myCards.map((card, i) => `
                        <button class="card ${gameState.selectedCard === i ? 'selected' : ''}" 
                                onclick="selectCard(${i})"
                                ${hasSubmitted ? 'disabled' : ''}>
                            ${card}
                        </button>
                    `).join('')}
                </div>
            `;
            document.getElementById('game-content').innerHTML = html;
        }

        function selectCard(index) {
            if (gameState.selectedCard !== null) return;
            
            gameState.selectedCard = index;
            const card = gameState.myCards[index];
            
            const submission = {
                playerId: myPeerId,
                playerName: playerName,
                card: card,
                cardIndex: index
            };

            if (isHost) {
                gameState.submissions.push(submission);
                const nonJudgePlayers = gameState.players.length - 1;
                if (gameState.submissions.length === nonJudgePlayers) {
                    startVotingPhase();
                }
            } else {
                hostConnection.send({ type: 'submit-card', submission });
            }

            gameState.myCards.splice(index, 1);
            renderCardSelection();
        }

        function startVotingPhase() {
            if (!isHost) return;
            
            gameState.phase = 'voting';
            gameState.submissions.sort(() => Math.random() - 0.5);
            
            broadcast({ type: 'game-update', phase: 'voting', submissions: gameState.submissions });
            updateGameUI();
        }

        function renderVoting() {
            const html = `
                <h3 style="text-align: center; margin: 20px 0;">üë®‚Äç‚öñÔ∏è Scegli il meme migliore:</h3>
                <div class="cards-grid">
                    ${gameState.submissions.map((sub, i) => `
                        <button class="card" onclick="voteCard(${i})">
                            ${sub.card}
                        </button>
                    `).join('')}
                </div>
            `;
            document.getElementById('game-content').innerHTML = html;
        }

        function voteCard(index) {
            if (isHost) {
                handleVote(index);
            } else {
                hostConnection.send({ type: 'vote', cardIndex: index });
            }
        }

        function handleVote(cardIndex) {
            if (!isHost) return;
            
            const winner = gameState.submissions[cardIndex];
            const winnerPlayer = gameState.players.find(p => p.id === winner.playerId);
            
            if (winnerPlayer) {
                winnerPlayer.score = (winnerPlayer.score || 0) + 1;
            }

            gameState.phase = 'results';
            gameState.lastWinner = winner;

            broadcast({ type: 'game-update', phase: 'results', lastWinner: winner, players: gameState.players });
            updateGameUI();

            setTimeout(() => {
                if (winnerPlayer && winnerPlayer.score >= 5) {
                    alert(`üéâ ${winnerPlayer.name} ha vinto la partita!`);
                    location.reload();
                } else {
                    nextRound();
                }
            }, 5000);
        }

        function renderResults() {
            if (!gameState.lastWinner) return;
            
            const html = `
                <div class="winner-card">
                    <h3>üèÜ Vincitore del round:</h3>
                    <p style="font-size: 1.3rem; margin: 15px 0;">"${gameState.lastWinner.card}"</p>
                    <p>di <strong>${gameState.lastWinner.playerName}</strong></p>
                </div>
                <div style="text-align: center; color: #666; font-style: italic; margin-top: 20px;">
                    Prossimo round tra qualche secondo...
                </div>
            `;
            document.getElementById('game-content').innerHTML = html;
        }

        function nextRound() {
            if (!isHost) return;

            gameState.currentRound++;
            gameState.judgeIndex = Math.floor(Math.random() * gameState.players.length);
            gameState.phase = 'judge-selecting';
            gameState.submissions = [];
            gameState.selectedCard = null;
            gameState.currentImage = null;

            gameState.players.forEach(player => {
                while (player.cards.length < 7) {
                    player.cards.push(TEXT_CARDS[Math.floor(Math.random() * TEXT_CARDS.length)]);
                }
            });

            const updateData = {
                type: 'game-update',
                currentRound: gameState.currentRound,
                judgeIndex: gameState.judgeIndex,
                phase: gameState.phase,
                currentImage: null,
                submissions: [],
                players: gameState.players
            };

            broadcast(updateData);
            updateGameState(updateData);
        }

        function updateGameState(data) {
            Object.assign(gameState, data);
            
            const me = gameState.players.find(p => p.id === myPeerId);
            if (me && me.cards) {
                gameState.myCards = me.cards;
            }
            
            gameState.selectedCard = null;
            updateGameUI();
        }

        function getRandomCards(count) {
            const shuffled = [...TEXT_CARDS].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.add('active');
            }
        }

        function showError(msg) {
            const container = document.getElementById('error-container');
            if (container) {
                container.innerHTML = `<div class="error-message">${msg}</div>`;
                setTimeout(() => container.innerHTML = '', 5000);
            }
            console.error(msg);
        }

        function showStatus(msg) {
            const container = document.getElementById('status-container');
            if (container) {
                container.innerHTML = `<div class="status-message"><p>${msg}</p></div>`;
            }
        }

        function copyRoomCode() {
            const code = document.getElementById('room-code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Codice copiato negli appunti! üìã\nInvialo ai tuoi amici per farli unire.');
            }).catch(() => {
                alert('Codice: ' + code + '\n\nCopialo e invialo ai tuoi amici!');
            });
        }

        function leaveLobby() {
            if (confirm('Vuoi davvero lasciare la partita?')) {
                location.reload();
            }
        }

        console.log('Meme Game P2P loaded successfully!');
    </script>
</body>
</html>
